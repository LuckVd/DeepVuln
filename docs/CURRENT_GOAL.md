# 当前目标

> 单一焦点：本次会话关注的核心任务

---

## 目标信息

| 字段 | 值 |
|------|-----|
| **任务** | 修复 L3 Agent 文件选择逻辑：优先分析 L1 检测到的入口点文件 |
| **状态** | completed |
| **完成日期** | 2026-02-28 |
| **优先级** | high |
| **创建日期** | 2026-02-28 |

---

## 背景

### 现状问题

经过调试发现，L3 Agent 分析的文件与 L1 检测到的入口点文件**完全不重叠**：

```
L1 入口点文件 (23 个): backend/api/**/*.go
L3 分析文件 (50 个): backend/pro_imports.go, sdk/rag/*.go, ...
重叠: 0 个文件！
```

**根本原因**：
- `rglob("*.go")` 按目录顺序返回文件
- `backend/api/` 目录排在 `backend/pro_imports.go` 和 `sdk/rag/` 之后
- L3 选取前 50 个文件，完全错过了入口点文件

### 目标

修改 `src/cli/main.py` 的 Phase 3，让 L3 Agent 优先分析 L1 检测到的入口点文件：

1. 优先使用 L1 检测到的入口点文件
2. 如果入口点文件不足 50 个，再用其他文件填充
3. 确保日志显示正在分析入口点文件

---

## 完成标准

### P1: 核心修复
- [x] 修改 Phase 3 文件选择逻辑
- [x] 优先使用 `surface_report.entry_points` 中的文件
- [x] 添加回退逻辑（如果 L1 未运行或无入口点）

### P2: 日志改进
- [x] 显示"Analyzing N entry point files"
- [x] 如果有填充文件，显示"and M other files"

### P3: 验证
- [x] 重新运行扫描，确认 L3 分析入口点文件
- [x] 确认 Agent 能检测到漏洞（验证脚本通过）

---

## 关键文件修改

| 文件 | 操作 | 说明 |
|------|------|------|
| `src/cli/main.py` | 修改 | Phase 3 文件选择逻辑 |

---

## 进度记录

| 时间 | 进展 |
|------|------|
| 2026-02-28 22:30 | 创建调试脚本发现 L1/L3 文件重叠为 0 |
| 2026-02-28 22:35 | 确认根本原因：文件选择逻辑未考虑入口点 |
| 2026-02-28 22:40 | 设置目标，准备实现修复 |
| 2026-02-28 22:45 | 修改 main.py Phase 3 文件选择逻辑 |
| 2026-02-28 22:50 | 验证通过：L1/L3 文件重叠从 0 提升到 12 |

---

## 相关调试文件

- `debug_agent_response.py` - 测试 GLM-5 漏洞检测能力（证实 GLM-5 能检测漏洞）
- `debug_context_builder.py` - 测试 ContextBuilder 输出
- `debug_file_mismatch.py` - 分析 L1/L3 文件重叠问题

---

## 预期效果

- Agent 优先分析 HTTP/RPC/MQ 等入口点代码
- 提高漏洞检出率（入口点更可能包含安全问题）
- 与 L1 检测结果形成有效联动
